<!doctype html>
<html lang="en">
<head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <style type="text/css">
        * {
    font-family: 'Open Sans', sans-serif;
}

a, a:hover, footer .fa {
    color: #E99749;
}

a.icon {
    text-decoration: none;
}

pre {
    padding: 5px;
    border: 2px solid #E99749;
    background: #F8F9FA;
}

pre code {
    font-family: 'Courier', sans-serif;
    font-size: 0.9em;
}


.nav-link {
    padding: 0;
    margin: 0;
}

.sidebar p {
    padding: 0;
    margin: 0;
}

img.img-fluid {
    max-width: 500px;
}
    </style>
</head>
<body>
<div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
    <h5 class="my-0 mr-md-auto font-weight-normal">
        <img src="https://avatars0.githubusercontent.com/u/710363?s=45&v=4" alt="Novactive"/>
        Nova eZ Platform Bundles
    </h5>
    <ul class="navbar-nav mr-auto">
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="" id="components-menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Bundles
            </a>
            <div class="dropdown-menu" aria-labelledby="components-menu">

                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/2FABundle/README.md.html">2FABundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/Accelerator/README.md.html">Accelerator</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/AlgoliaSearchEngine/README.md.html">AlgoliaSearchEngine</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/CloudinaryBundle/README.md.html">CloudinaryBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/EditHelpBundle/README.md.html">EditHelpBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/EnhancedImageAssetBundle/README.md.html">EnhancedImageAssetBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/ExtraBundle/README.md.html">ExtraBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/FastlyImageOptimizerBundle/README.md.html">FastlyImageOptimizerBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/LdapAuthenticatorBundle/README.md.html">LdapAuthenticatorBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/MailingBundle/README.md.html">MailingBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/MaintenanceBundle/README.md.html">MaintenanceBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/MenuManagerBundle/README.md.html">MenuManagerBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/ProtectedContentBundle/README.md.html">ProtectedContentBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/ResponsiveImagesBundle/README.md.html">ResponsiveImagesBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/RssFeedBundle/README.md.html">RssFeedBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/SEOBundle/README.md.html">SEOBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/SlackBundle/README.md.html">SlackBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/SolrSearchExtraBundle/README.md.html">SolrSearchExtraBundle</a>
                                    <a class="dropdown-item" href="/Nova-eZPlatform-Bundles/master/StaticTemplatesBundle/README.md.html">StaticTemplatesBundle</a>
                            </div>
        </li>
    </ul>
    <nav class="my-2 my-md-0 mr-md-3">
        <a class="p-2 text-dark" target="_blank" href="https://www.novactive.com">France</a>
        <a class="p-2 text-dark" target="_blank" href="https://www.novactive.us">California</a>
        <a class="p-2 text-dark" target="_blank" href="https://www.nextedia.com">Nextedia</a>
        <a class="p-2 text-dark icon" target="_blank" href="https://github.com/Novactive/Nova-eZPlatform-Bundles"><i class="fab fa-github fa-2x" aria-hidden="true"></i>&nbsp;&nbsp;</a>
    </nav>
</div>

<div class="container-fluid">
        <div class="row flex-column-reverse flex-md-row">
        <div class="col-md-8 col-sm-12">
            <h1 name="9eac6633d000352376123c680b96b3f7">Novactive eZ 2FA Bundle</h1>
<hr />
<p>Novactive eZ 2FA Bundle provides two-factor authentication for your ezplatform/ibexa project.</p>
<h2 name="7cd8fb6e31cc946c078d2740c76a9899">Installation</h2>
<h3 name="5a2ebfb8baa378cfcfcba58bbb1380c2">Requirements</h3>
<ul>
<li>eZ Platform 3.1+</li>
<li>PHP 7.3</li>
</ul>
<h3 name="6065c97227a6214bc68bad0f15ff16d1">Use Composer</h3>
<p>Add the lib to your composer.json, run <code>composer require novactive/ez2fabundle</code> to refresh dependencies.</p>
<h3 name="040da9acc61145e551bcf66b54f44420">Register the bundle</h3>
<p>Then inject the bundle in the <code>config\bundles.php</code> of your application.</p>
<pre><code class=" php">    return [
        // ...
        Scheb\TwoFactorBundle\SchebTwoFactorBundle::class =&gt; ['all' =&gt; true],
        Novactive\Bundle\eZ2FABundle\NovaeZ2FABundle::class =&gt; [ 'all'=&gt; true ],
    ];</code></pre>
<h3 name="814b1401d1a609253b98ac549a68a493">Add routes</h3>
<p>Make sure you add this route to your routing:</p>
<pre><code class=" yaml"># config/routes.yaml

_novaez2fa_routes:
    resource: '@NovaeZ2FABundle/Resources/config/routing.yaml'
</code></pre>
<h3 name="8f55e285551800b41684b2c637d6eb63">Update Configuration</h3>
<pre><code class=" yaml"># config/security.yaml

security:
    ...
    firewalls:
        ...
        ezpublish_front:
            pattern: ^/
            user_checker: eZ\Publish\Core\MVC\Symfony\Security\UserChecker
            anonymous: ~
            ezpublish_rest_session: ~
            form_login:
                require_previous_session: false
                csrf_token_generator: security.csrf.token_manager
            logout: ~
            two_factor:
                auth_form_path: 2fa_login    # The route name you have used in the routes.yaml
                check_path: 2fa_login_check  # The route name you have used in the routes.yaml
                default_target_path: /                # Where to redirect by default after successful authentication
                always_use_default_target_path: true  # If it should always redirect to default_target_path

    ...
    access_control:
        - { path: ^/_fos_user_context_hash, role: PUBLIC_ACCESS }
        - { path: ^/logout, role: IS_AUTHENTICATED_ANONYMOUSLY }
        - { path: ^/logout, role: IS_AUTHENTICATED_2FA_IN_PROGRESS }
        - { path: 2fa_setup$, role: ROLE_USER }
        - { path: 2fa_reset$, role: ROLE_USER }
        - { path: ^/2fa, role: IS_AUTHENTICATED_2FA_IN_PROGRESS }
        - { path: ^/admin/2fa, role: IS_AUTHENTICATED_2FA_IN_PROGRESS }
        - { path: ^/_fos_user_context_hash, role: IS_AUTHENTICATED_2FA_IN_PROGRESS }
</code></pre>
<h3 name="2a84d9915b12fcb0c1436709a77a8dd0">Add new configuration</h3>
<p>The values can be updated according to the project specification</p>
<pre><code class=" yaml"># config/packages/scheb_two_factor.yaml

scheb_two_factor:

    backup_codes:
        enabled: '%nova_ez2fa.backup_codes.enabled%' # Reading the value from the nova_ez2fa.backup_codes.enabled value in parameters section
        manager: Novactive\Bundle\eZ2FABundle\Core\BackupCodeManager # This should either remain or be replaced with another one developed for that purpose

    google:
        enabled: true
        server_name: Local Ez Server                # Server name used in QR code
        issuer: EzIssuer                            # Issuer name used in QR code
        digits: 6                                   # Number of digits in authentication code
        window: 1                                   # How many codes before/after the current one would be accepted as valid
        template: "@ezdesign/2fa/auth.html.twig"    # Template for the 2FA login page

    # TOTP Authenticator config
    totp:
        enabled: true                               # If TOTP authentication should be enabled, default false
        server_name: Server Name                    # Server name used in QR code
        issuer: TOTP Issuer                         # Issuer name used in QR code
        window: 1                                   # How many codes before/after the current one would be accepted as valid
        template: "@ezdesign/2fa/auth.html.twig"    # Template used to render the authentication form

    # Trusted device feature
    trusted_device:
        enabled: true                                   # If the trusted device feature should be enabled
        # manager: acme.custom_trusted_device_manager   # Use a custom trusted device manager
        lifetime: 259200                                # Lifetime of the trusted device token, in seconds
        extend_lifetime: false                          # Automatically extend lifetime of the trusted cookie on re-login
        cookie_name: trusted_device                     # Name of the trusted device cookie
        cookie_secure: true                             # Set the 'Secure' (HTTPS Only) flag on the trusted device cookie
        cookie_same_site: "lax"                         # The same-site option of the cookie, can be "lax", "strict" or null
        # cookie_domain: ""                             # Domain to use when setting the cookie, fallback to the request domain if not set
        cookie_path: "/"                                # Path to use when setting the cookie

    email:
        enabled: true                            # If email authentication should be enabled, default false
        mailer: Novactive\Bundle\eZ2FABundle\Core\AuthCodeMailer # Use alternative service to send the authentication code
        code_generator: Novactive\Bundle\eZ2FABundle\Core\EmailCodeGenerator # Use alternative service to generate authentication code
        sender_email: me@example.com             # Sender email address
        sender_name: John Doe                    # Sender name
        digits: 6                                # Number of digits in authentication code
        template: "@ezdesign/2fa/auth.html.twig" # Template used to render the authentication form

    # The security token classes, which trigger two-factor authentication.
    # By default the bundle only reacts to Symfony's username+password authentication. If you want to enable
    # two-factor authentication for other authentication methods, add their security token classes.
    # See the configuration reference at https://github.com/scheb/two-factor-bundle/blob/4.x/Resources/doc/configuration.md
    security_tokens:
        - Symfony\Component\Security\Core\Authentication\Token\UsernamePasswordToken
        # If you're using guard-based authentication, you have to use this one:
        # - Symfony\Component\Security\Guard\Token\PostAuthenticationGuardToken
        # If you're using authenticator-based security (introduced in Symfony 5.1), you have to use this one:
        # - Symfony\Component\Security\Http\Authenticator\Token\PostAuthenticationToken

# Whether to use the backup codes or not should be specified here in parameters section, then used in scheb_two_factor.backup_codes
# It's done this way in order to let the user customize if the backup codes should be generated or not
parameters:
    nova_ez2fa.backup_codes.enabled: true
</code></pre>
<p>If email method is enabled then <strong>MAILER_DSN</strong> env variable should be specified in the .env file</p>
<p>For full <strong>scheb_two_factor</strong> reference visit the following resource: <a href="https://github.com/scheb/two-factor-bundle/blob/4.x/Resources/doc/configuration.md">https://github.com/scheb/two-factor-bundle/blob/4.x/Resources/doc/configuration.md</a></p>
<blockquote>
<p><strong>Note to keep in mind</strong>: This bundle is Siteaccess aware so each Siteaccess can have different authentication method.</p>
</blockquote>
<pre><code class=" yaml"># config/packages/nova_ez2fa.yaml

nova_ez2fa:
    system:
        # Available mobile methods - google, totp, microsoft or null.
        # If microsoft is selected the totp mechanism is still used but the config is forced and static so Microsoft Authenticator app can be used.
        # Email method can also be enabled or disabled for each siteaccess
        # If 2fa_force_setup is true then the User must always set up 2FA upon authentication and reset function is off
        default:
            2fa_mobile_method: google
            2fa_email_method_enabled: true
            2fa_force_setup: false
        site:
            2fa_mobile_method: totp
            # if microsoft method set - the config is forced to: algorithm: sha1, period: 30, digits: 6
            config:
                algorithm: sha1 #(md5, sha1, sha256, sha512)
                period: 30
                digits: 6
            2fa_email_method_enabled: true
            2fa_force_setup: false
</code></pre>
<h3 name="8689a46961f5ee90841967e0a68a677d">Create the table in DB:</h3>
<p>See the file <code>bundle/Resources/sql/schema.sql</code></p>
<h3 name="bb2420d0c739938919dd041e0a217244">Especial instructions for HTTP Cache</h3>
<p><strong>Important!</strong>: For the HTTP Cache system (e.g. Varnish or Fastly) the following logic should be implemented:</p>
<pre><code class=" vcl">if (req.url ~ "^/2fa") {
    return (pass);
}</code></pre>
<p>and it should be added before the <code>call ez_user_context_hash</code> line.</p>
<p>We need it in order to avoid triggering the X User Hash mechanism when /2fa request is sent, so the <code>/_fos_user_context_hash</code> request would not return 302 redirect response because of this bundle.</p>
<h4 name="9d6dd462cebdc91d2e4f3889edabea1d"><a href="UPGRADE.md.html">Upgrade Instructions</a></h4>
<h3 name="a619491466c157829c3dd8cb13872622">Manually removing 2FA record for specific User:</h3>
<p>If some User needs its 2FA record in the database removed to be able to login without entering 2FA code run the following command <code>acx:users:remove-2fa</code> with specifying user's login:</p>
<pre><code class=" shell">
php ezplatform/bin/console nova:2fa:remove-secret-key user_login
</code></pre>
<blockquote>
<p><strong>Note to keep in mind</strong>: If you have the 2FA already set up for the user and you're going to reset it by following the corresponding link on the 2FA Setup page don't change the method for the current Siteaccess before that! Because in this case the secret key will be supposed to be removed for the new method not for the old one and hence the reset won't work!</p>
</blockquote>

            <p class="text-right">
                <img width="204" height="20"
                     src='https://img.shields.io/badge/Updated on-01--21--2022 18:00:32-green?style=flat-square&labelColor=black'
                     alt='Updated on 01--21--2022 18:00:32'
                />
            </p>
        </div>
        <div class="col-md-4 col-sm-12 d-print-none sidebar">
                            <p><strong>In this page</strong>:</p>
                <ul class="nav flex-column"><li class="nav-item first last"><a href="#9eac6633d000352376123c680b96b3f7" class="nav-link">Novactive eZ 2FA Bundle</a><ul class="menu_level_1"><li class="nav-item first last"><a href="#7cd8fb6e31cc946c078d2740c76a9899" class="nav-link">Installation</a><ul class="menu_level_2"><li class="nav-item first"><a href="#5a2ebfb8baa378cfcfcba58bbb1380c2" class="nav-link">Requirements</a></li><li class="nav-item"><a href="#6065c97227a6214bc68bad0f15ff16d1" class="nav-link">Use Composer</a></li><li class="nav-item"><a href="#040da9acc61145e551bcf66b54f44420" class="nav-link">Register the bundle</a></li><li class="nav-item"><a href="#814b1401d1a609253b98ac549a68a493" class="nav-link">Add routes</a></li><li class="nav-item"><a href="#8f55e285551800b41684b2c637d6eb63" class="nav-link">Update Configuration</a></li><li class="nav-item"><a href="#2a84d9915b12fcb0c1436709a77a8dd0" class="nav-link">Add new configuration</a></li><li class="nav-item"><a href="#8689a46961f5ee90841967e0a68a677d" class="nav-link">Create the table in DB:</a></li><li class="nav-item"><a href="#bb2420d0c739938919dd041e0a217244" class="nav-link">Especial instructions for HTTP Cache</a><ul class="menu_level_3"><li class="nav-item first last"><a href="#9d6dd462cebdc91d2e4f3889edabea1d" class="nav-link">[Upgrade Instructions](UPGRADE.md)</a></li></ul></li><li class="nav-item last"><a href="#a619491466c157829c3dd8cb13872622" class="nav-link">Manually removing 2FA record for specific User:</a></li></ul></li></ul></li></ul>
                    </div>
    </div>
    <footer class="pt-4 my-md-5 pt-md-5 border-top">
    <div class="row">
        <div class="col-2">
            <img class="mb-2" src="https://avatars0.githubusercontent.com/u/710363?s=60&v=4" width="24" height="24" alt="Novactive"/>
            <small class="d-block mb-3 text-muted">&copy; 2022</small>
        </div>
        <div class="col-8">
            <p class="text-center">
                <i class="fas fa-code"></i> with
                <i class="fas fa-heart"></i> in Paris, Toulon, Nantes, Bordeaux and California.
            </p>
        </div>
        <div class="col-2">
            <p class="text-right">
                <a href="#">
                    Back to top
                </a>
            </p>
        </div>
    </div>
</footer>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

<link rel="stylesheet"  href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/github.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script>

<script type="text/javascript">
    $(function () {
        function _scrollToName (hash) {
            var name = hash.substr(1);
            var to = (name === '') ? 0 : $("[name=" + name + "]").offset().top - 10;
            $('html, body').animate({
                scrollTop: to
            }, 'slow');
        }

        $('a[href^="#"]').click(function () {
            var selector = $(this).attr("href");
            _scrollToName(selector);
            return false;
        });

        if (location.hash) {
            _scrollToName(location.hash);
        }
    });
    hljs.initHighlightingOnLoad();
</script>
</body>
</html>

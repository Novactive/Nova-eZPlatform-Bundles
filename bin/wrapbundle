#!/usr/bin/env php
<?php

/**
 * eZ Platform Bundles Mono Repo Project.
 *
 * @author    Novactive - SÃ©bastien Morel <s.morel@novactive.com> aka Plopix <morel.seb@gmail.com>
 * @copyright 2020 Novactive
 * @license   MIT
 */

declare(strict_types=1);

$componentName = $_SERVER['COMPONENT'];
$configDir = "components/{$componentName}/tests/provisioning";
if (!file_exists($configDir)) {
    exit(0);
}

$appRootDir = __DIR__."/../ibexa";
$componentDir = __DIR__."/../components/" . $componentName;

$bundleComposerJson = json_decode(file_get_contents("{$componentDir}/composer.json"), true, 512, JSON_THROW_ON_ERROR);
$bundleComposerName = $bundleComposerJson['name'];
$bundleName = str_replace( '/', '_', $bundleComposerName );

exec("cd {$appRootDir} && composer config repositories.{$bundleName} '{\"type\": \"path\", \"url\": \"../components/{$componentName}\", \"options\": {\"symlink\": true}}' --json");
exec("cd {$appRootDir} && composer require {$bundleComposerName}:dev-master --no-update");
exec("cd {$appRootDir} && yarn install --cwd ../components/{$componentName}");


/**
 * Enable Bundle
 */
$bundleFile = "{$appRootDir}/config/bundles.php";
$bundleList = file_get_contents($bundleFile);
$bundles = array_map(
        function ($line) {
            $fqdn = trim(trim($line, "- "));

            return "{$fqdn}::class => [ 'all'=> true ],";
        },
        file($configDir."/bundles.yaml")
);

$bundleList = str_replace( '];', implode( PHP_EOL, $bundles) . PHP_EOL . '];', $bundleList);
file_put_contents($bundleFile, $bundleList);

/**
 * Inject the configurations
 */
if (file_exists($configDir."/configs.yaml") && trim(file_get_contents($configDir."/configs.yaml")) !== '') {
    $firstLine = substr(trim(file($configDir."/configs.yaml")[0]), 0, -1);
    file_put_contents(
        "{$appRootDir}/config/packages/{$bundleName}.yaml",
        file_get_contents($configDir."/configs.yaml")
    );
}

/**
 * Inject the routes
 */
if (file_exists($configDir."/routes.yaml") && trim(file_get_contents($configDir."/routes.yaml")) !== '') {
    file_put_contents(
        "{$appRootDir}/config/routes/{$bundleName}.yaml",
        file_get_contents($configDir."/routes.yaml")
    );
}
